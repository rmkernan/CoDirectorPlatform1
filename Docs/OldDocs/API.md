# Co-Director API Documentation
<!-- Last updated: May 9, 2025, 4:35 PM ET -->

## Overview

Co-Director interacts with two external webhook endpoints:

1. **WEBHOOK_A_URL**: Handles session management and chat interactions
   - Has separate test and production URLs that can be toggled in the UI
   - Test URL: Used for development and testing
   - Production URL: Used for production environment
2. **WEBHOOK_B_URL**: Manages session history and feedback

## Webhook A Endpoints

### Start Session

Initializes a new testing session.

- **URL**: `{WEBHOOK_A_URL}`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "sessionId": "session-[timestamp]-[uuid]",
    "principlesDocId": "string",
    "scenarioDocIds": ["string"],
    "sessionTopic": "string",
    "userQuery": null,
    "historyTurnsSetting": number,
    "testerId": "string"
  }
  ```

  Note: The `sessionId` is dynamically generated by the web application using a format of "session-[timestamp]-[uuid]" to ensure uniqueness.
Process: Fetches scenario and principles documents, combines them with clear separation markers, creates Gemini context cache with combined content using snake_case parameter names (system_instruction, display_name), and stores session data with cache ID and metadata in Supabase

- **Response**:

  The response uses the Simple Message Format:
  ```json
  {
    "message": "Session data stored successfully in Supabase"
  }
  ```

  Or in case of an error:
  ```json
  {
    "message": "Error storing session data: [error details]"
  }
  ```

  The web application automatically interprets this as a success response and stores the complete response for debugging purposes.

### Send Message

Sends a user message to the AI and receives a response.

- **URL**: `{WEBHOOK_A_URL}`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "sessionId": "string",
    "userQuery": "string"
  }
  ```

Process: Retrieves session data from Supabase, checks cache expiry, retrieves chat history using Postgres node with proper SQL formatting (including quoted identifiers and string values), performs RAG against handbook embeddings, calls Gemini API with context, and logs the interaction.
- **Response (Success)**:
  ```json
  {
    "success": true,
    "aiResponseText": "string"
  }
  ```
- **Response (Cache Expired)**:
  ```json
  {
    "success": false,
    "error": "CACHE_EXPIRED",
    "message": "Cache has expired. Please start a new session.",
    "data": {
      "sessionId": "string",
      "expiryTime": "ISO-string"
    }
  }
  ```

### End Session

Terminates an active session.

- **URL**: `{WEBHOOK_A_URL}/end-session`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "sessionId": "string"
  }
  ```
- **Response**:
  ```json
  {
    "success": true,
    "message": "Session ended successfully"
  }
  ```

## Webhook B Endpoints

### Get Session History

Retrieves a list of past sessions.

- **URL**: `{WEBHOOK_B_URL}/api/sessions`
- **Method**: GET
- **Response**:
  ```json
  {
    "success": true,
    "data": [
      {
        "sessionId": "string",
        "startTime": "ISO-string",
        "sessionTopic": "string",
        "testerId": "string",
        "totalTurns": number,
        "rating": number | null,
        "tags": ["string"]
      }
    ]
  }
  ```

### Get Session Details

Retrieves detailed information about a specific session.

- **URL**: `{WEBHOOK_B_URL}/api/sessions/{sessionId}/details`
- **Method**: GET
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "sessionId": "string",
      "startTime": "ISO-string",
      "sessionTopic": "string",
      "testerId": "string",
      "totalTurns": number,
      "rating": number | null,
      "tags": ["string"],
      "principlesDocId": "string",
      "scenarioDocIds": ["string"],
      "historyTurnsSetting": number,
      "history": [
        {
          "role": "user" | "ai" | "feedback",
          "content": "string",
          "timestamp": "ISO-string",
          "geminiCacheIdUsed": "string",
          "modelUsed": "string",
          "responseLatency": number
        }
      ],
      "userNotes": "string"
    }
  }
  ```

### Save Session Feedback

Saves user feedback for a session.

- **URL**: `{WEBHOOK_B_URL}/api/sessions/{sessionId}/feedback`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "userNotes": "string",
    "rating": number,
    "tags": ["string"]
  }
  ```
- **Response**:
  ```json
  {
    "success": true,
    "message": "Feedback saved successfully"
  }
  ```

## Response Formats

The application supports multiple webhook response formats for better compatibility with n8n workflows.

### Standard Response Format

The preferred response format includes a `success` flag, optional `message`, and optional `data` object:

```json
{
  "success": true,
  "message": "Operation completed successfully",
  "data": {
    // Operation-specific data
  },
  "statusCode": 200
}
```

### Simple Message Format

A simplified format with just a message (automatically interpreted as success):

```json
{
  "message": "Session data stored successfully in Supabase"
}
```

### Error Response Format

All endpoints may return error responses in the following format:

```json
{
  "success": false,
  "error": {
    "userMessage": "Human-readable error message",
    "technicalMessage": "Detailed technical information (optional)"
  },
  "statusCode": 400
}
```

## Webhook Response Display

The application includes a webhook response display component in the Setup tab that shows:

1. Success/error status with appropriate icons
2. Message or error information
3. Raw response data in a collapsible section

This feature is useful for debugging API interactions and understanding webhook responses.